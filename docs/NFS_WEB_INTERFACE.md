# Управление NFS через веб-интерфейс

Приложение предоставляет возможность монтирования и управления NFS шары прямо из веб-интерфейса на странице конфигурации.

## Доступ к функции

1. Откройте страницу **Configuration** в веб-интерфейсе
2. В верхней части страницы находится секция **"NFS Mount Management"**

## Возможности

### 1. Проверка статуса монтирования

Нажмите кнопку **"Check Status"** для проверки текущего состояния NFS монтирования:
- Показывает, смонтирована ли NFS
- Отображает точку монтирования
- Показывает информацию о текущем монтировании

Статус проверяется автоматически при загрузке страницы.

### 2. Тестирование NFS сервера

1. Введите адрес NFS сервера в формате `SERVER:/path` (например, `172.20.129.1:/backups`)
2. Нажмите кнопку **"Test"** рядом с полем NFS Server
3. Приложение проверит:
   - Доступность сервера (ping)
   - Доступные экспорты (если команда `showmount` доступна)

### 3. Создание директории (опционально)

Если директория для монтирования не существует, вы можете создать её заранее:

1. Укажите путь в поле **"Mount Point"**
2. Нажмите кнопку **"Create Directory"**
3. Директория будет создана с правами доступа 755

**Примечание:** Директория автоматически создастся при монтировании, если её не существует.

### 4. Монтирование NFS

1. Заполните поля:
   - **NFS Server**: адрес сервера и путь (например, `172.20.129.1:/backups`)
   - **Mount Point**: локальная директория для монтирования (например, `/mnt/veeam_nfs`)
   - **NFS Options**: опции монтирования (можно оставить по умолчанию)
2. Нажмите кнопку **"Mount NFS"**
3. Если директория не существует, она будет создана автоматически
4. После успешного монтирования:
   - Поле "NFS Path" в конфигурации автоматически заполнится значением из "Mount Point"
   - Статус обновится автоматически

### 5. Размонтирование NFS

1. Укажите точку монтирования в поле **"Mount Point"**
2. Нажмите кнопку **"Unmount NFS"**
3. Подтвердите действие в диалоговом окне
4. Статус обновится автоматически

## Требования

### Права доступа

Монтирование NFS требует прав root. Есть несколько вариантов:

#### Вариант 1: Запуск приложения от root

```bash
sudo python run.py
```

#### Вариант 2: Настройка sudo без пароля (рекомендуется для безопасности)

1. Создайте файл `/etc/sudoers.d/nfs-mount`:
   ```bash
   sudo nano /etc/sudoers.d/nfs-mount
   ```

2. Добавьте строку (замените `username` на пользователя, от которого запускается приложение):
   ```
   username ALL=(ALL) NOPASSWD: /bin/mount, /bin/umount
   ```

3. Сохраните и закройте файл

4. Проверьте синтаксис:
   ```bash
   sudo visudo -c
   ```

#### Вариант 3: Использование systemd для автоматического монтирования

Рекомендуется использовать автоматическое монтирование через systemd (см. `docs/NFS_AUTOMOUNT.md`), а в веб-интерфейсе только проверять статус и управлять уже смонтированными NFS.

## Безопасность

Приложение имеет встроенные ограничения безопасности:

- **Ограничение путей монтирования**: можно монтировать только в директории под `/mnt/`
- **Валидация формата**: проверка корректности формата адреса NFS сервера
- **Защита от path traversal**: блокировка использования `..` в путях

## Формат NFS сервера

Формат: `SERVER:/path`

Примеры:
- `172.20.129.1:/backups`
- `nfs-server.example.com:/data/backups`
- `192.168.1.100:/export/veeam`

## NFS опции монтирования

По умолчанию используются опции:
```
vers=4.1,soft,timeo=30,retrans=3,noatime
```

**Опции:**
- `vers=4.1` - версия NFS протокола
- `soft` - не блокировать при недоступности NFS
- `timeo=30` - таймаут (3 секунды)
- `retrans=3` - количество попыток
- `noatime` - не обновлять время доступа (улучшает производительность)

Для стабильной сети можно использовать `hard` вместо `soft`:
```
vers=4.1,hard,timeo=30,retrans=3,noatime
```

## API Endpoints

Для интеграции с другими системами доступны следующие API endpoints:

### GET /api/nfs/status
Проверка статуса монтирования NFS

**Параметры:**
- `mount_point` (optional) - точка монтирования

**Пример:**
```bash
curl http://localhost:5000/api/nfs/status?mount_point=/mnt/veeam_nfs
```

### POST /api/nfs/mount
Монтирование NFS

**Body:**
```json
{
  "nfs_server": "172.20.129.1:/backups",
  "mount_point": "/mnt/veeam_nfs",
  "nfs_options": "vers=4.1,soft,timeo=30,retrans=3,noatime"
}
```

### POST /api/nfs/unmount
Размонтирование NFS

**Body:**
```json
{
  "mount_point": "/mnt/veeam_nfs"
}
```

### POST /api/nfs/create-directory
Создание локальной директории для монтирования

**Body:**
```json
{
  "mount_point": "/mnt/veeam_nfs",
  "permissions": "755"
}
```

**Примечание:** Директория создается автоматически при монтировании, если она не существует.

### POST /api/nfs/test
Тестирование доступности NFS сервера

**Body:**
```json
{
  "nfs_server": "172.20.129.1:/backups"
}
```

Все API endpoints требуют аутентификации (`@login_required`).

## Устранение неполадок

### Ошибка "Требуются права root"

**Решение:**
- Запустите приложение от root, или
- Настройте sudo без пароля (см. выше), или
- Используйте systemd для автоматического монтирования

### Ошибка "Invalid mount point path"

**Причина:** Точка монтирования должна начинаться с `/mnt/`

**Решение:** Используйте пути вида `/mnt/...`

### NFS не монтируется

**Проверьте:**
1. Доступность NFS сервера (используйте кнопку "Test")
2. Правильность формата адреса NFS сервера
3. Права доступа на NFS сервере
4. Firewall правила

### После монтирования NFS недоступна

**Проверьте:**
1. Логи приложения для деталей ошибки
2. Статус монтирования через кнопку "Check Status"
3. Права доступа на точке монтирования: `ls -la /mnt/veeam_nfs`

## Интеграция с конфигурацией

После успешного монтирования NFS:
1. Поле "NFS Path" в секции "Connection Settings" автоматически заполняется значением из "Mount Point"
2. Можно сохранить конфигурацию для использования этой точки монтирования в загрузках

## Рекомендации

1. **Для продакшена**: Используйте systemd для автоматического монтирования при загрузке системы
2. **Для тестирования**: Используйте веб-интерфейс для быстрого монтирования/размонтирования
3. **Мониторинг**: Регулярно проверяйте статус NFS, особенно после перезагрузок сервера
4. **Безопасность**: Не монтируйте NFS из ненадежных источников

